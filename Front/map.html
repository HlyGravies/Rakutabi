<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTrip - Kết Quả Lộ Trình</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans JPをInterより優先的に適用 */
        body, html {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Ngăn cuộn toàn bộ trang */
        }
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* CSS CHO LIGHTBOX (Giữ nguyên) */
        .lightbox-overlay {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            overflow: auto; 
            backdrop-filter: blur(8px); /* Thêm hiệu ứng blur */
        }
        .lightbox-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
            max-width: 90vw; 
            max-height: 90vh; 
            border-radius: 12px; /* Bo góc ảnh */
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #ffffff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .lightbox-close:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="main-container flex w-full h-screen">
        <!-- Bảng điều khiển bên trái (Lộ trình) -->
        <div class="left-panel w-full md:w-2/5 lg:w-1/3 h-full overflow-y-auto bg-white shadow-lg z-10">
            <div id="left-panel-content">
                <!-- Nội dung sẽ được chèn bằng JavaScript -->
            </div>
        </div>
        <!-- Bảng điều khiển bên phải (Bản đồ) -->
        <div class="right-panel hidden md:block flex-grow h-full">
            <div id="map"></div>
        </div>
    </div>

    <!-- Lightbox (Giữ nguyên) -->
    <div id="lightbox" class="lightbox-overlay">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <script>
        // --- 0. Đặt API Key của bạn ở đây ---
        const API_KEY = "AIzaSyAmbdRFOMwNlwiUD-LEwTvvJ6Twb0JlpmU"; 

        // --- 1. BIẾN TOÀN CỤC ---
        let planData;
        let map; 
        let markers = []; 
        let infowindow;
        let lightbox;
        let lightboxImg;
        let lightboxClose;

        // --- 2. TẢI DỮ LIỆU TỪ FILE JSON ---
        const jsonFilePath = "../json/GeminiAPIResponse/MinimalSearch_pref_cafe_pref_sento_pref_bookstore_20251105_151058_geminiAPI.json";

        fetch(jsonFilePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Không tìm thấy file.`);
                }
                return response.json();
            })
            .then(data => {
                planData = data;
                populateLeftPanel(); 
                loadGoogleMapsScript(); // Tải script sau khi có dữ liệu
            })
            .catch(error => {
                console.error("Lỗi tải file JSON:", error);
                document.body.innerHTML = `<div class="p-10">
                    <h1 class="text-2xl font-bold text-red-600">Lỗi: Không tải được file JSON</h1>
                    <p class="mt-2 text-gray-700">${error.message}</p>
                    <p class="mt-1 text-gray-500 text-sm">Đường dẫn: ${jsonFilePath}</p>
                    <a href="minitrip_input.html" class="mt-4 inline-block px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700">Quay lại</a>
                </div>`;
            });

        
        // --- 3. HÀM ĐỔ DỮ LIỆU CỘT TRÁI (Thiết kế lại với Tailwind) ---
        function populateLeftPanel() {
            const panel = document.getElementById('left-panel-content');
            let content = '';
            
            // Header với nút Quay Lại
            content += `
                <div class="trip-header p-5 border-b sticky top-0 bg-white z-10">
                    <!-- Nút Quay Lại -->
                    <a href="minitrip_input.html" id="backButton" class="mb-4 inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-orange-500 transition duration-200">
                        <svg class="-ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 010 1.06L9.06 10l3.73 3.71a.75.75 0 11-1.06 1.06l-4.25-4.25a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 0z" clip-rule="evenodd" />
                        </svg>
                        新しい検索
                    </a>
                    <!-- Tiêu đề -->
                    <h1 class="text-3xl font-bold text-gray-900">${planData.plan_title}</h1>
                    <p class="text-base text-gray-600 mt-2">${planData.summary}</p>
                </div>
            `;
            
            // Danh sách địa điểm
            content += '<div class="waypoints-list divide-y divide-gray-200">';
            planData.waypoints.forEach((wp, i) => {
                let activityColor = 'bg-orange-100 text-orange-700'; // Màu cam mặc định
                if (wp.activity.includes("サプライズ") || wp.activity.includes("おまかせ")) {
                    activityColor = 'bg-purple-100 text-purple-700'; // Màu tím cho bất ngờ
                }

                content += `
                    <div class="waypoint-item p-5 cursor-pointer transition duration-200 hover:bg-orange-50" data-marker-index="${i}">
                        <div class="flex items-start">
                            <!-- Số thứ tự -->
                            <div class="waypoint-order text-xl font-bold text-orange-600 mr-4 pt-1">${wp.order}</div>
                            <!-- Chi tiết -->
                            <div class="waypoint-details flex-1">
                                <span class="activity text-xs font-semibold ${activityColor} rounded-full px-3 py-1 inline-block mb-3">${wp.activity}</span>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">${wp.name}</h3>
                                <p class="info text-sm text-gray-600 leading-relaxed">${wp.info}</p>
                                <!-- Gallery Ảnh -->
                                ${createPhotoGallery(wp.photo_references)} 
                            </div>
                        </div>
                    </div>
                `;
            });
            content += '</div>';
            panel.innerHTML = content;
        }

        // --- 3.5. HÀM TẠO GALLERY (Thiết kế lại với Tailwind) ---
        // --- 3.5. HÀM TẠO GALLERY (ĐÃ SỬA LỖI) ---
        function createPhotoGallery(references) {
            // "references" BÂY GIỜ LÀ MỘT MẢNG (ARRAY), không phải string

            // 1. Kiểm tra xem nó có phải là mảng hợp lệ không
            if (!Array.isArray(references) || references.length === 0) {
                return ''; // Trả về rỗng nếu không có ảnh hoặc không phải mảng
            }

            // 2. Nó đã là một mảng, KHÔNG CẦN DÙNG .split() nữa.
            //    Chỉ cần .slice() để lấy 5 ảnh đầu tiên.
            const refArray = references.slice(0, 5); 
            
            let galleryHTML = '<div class="photo-gallery mt-4 flex flex-wrap gap-2">';
            
            // 3. Vòng lặp
            refArray.forEach(ref => {
                // "ref" bây giờ là một string (ví dụ: "ảnh_ref_1")
                if (ref) { 
                    const thumbnailUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${ref}&key=${API_KEY}`;
                    galleryHTML += `
                        <img src="${thumbnailUrl}" 
                             class="thumbnail-img w-20 h-20 object-cover rounded-md cursor-pointer transition duration-200 hover:opacity-80 hover:scale-105" 
                             data-photoref="${ref}" 
                             alt="Ảnh địa điểm"
                             onerror="this.style.display='none'"> 
                    `;
                }
            });
            
            galleryHTML += '</div>';
            return galleryHTML;
        }

        // --- 4. HÀM INIT MAP ---
        function initMap() {
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true, // Tắt marker A, B, C, D
                polylineOptions: {
                    strokeColor: '#EA580C', // Màu cam
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });
            
            const firstLocation = planData.waypoints[0].location;
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: firstLocation,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });
            directionsRenderer.setMap(map);
            infowindow = new google.maps.InfoWindow();

            initLightbox();
            addMarkers();
            addPanelListeners(); 
            calculateAndDisplayRoute(directionsService, directionsRenderer);
        }

        // --- 5. HÀM INIT LIGHTBOX (Giữ nguyên) ---
        function initLightbox() {
            lightbox = document.getElementById('lightbox');
            lightboxImg = document.getElementById('lightbox-img');
            lightboxClose = document.querySelector('.lightbox-close');

            lightboxClose.addEventListener('click', () => {
                lightbox.style.display = 'none';
            });
            
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) { 
                    lightbox.style.display = 'none';
                }
            });
        }
        
        // --- 6. HÀM ADD MARKERS (Thiết kế lại marker) ---
        function addMarkers() {
            planData.waypoints.forEach((wp, i) => {
                // Xác định màu marker
                let markerColor = '#EA580C'; // Mặc định màu cam
                if (wp.activity.includes("サプライズ") || wp.activity.includes("おまかせ")) {
                    markerColor = '#9333EA'; // Màu tím cho bất ngờ
                }

                const marker = new google.maps.Marker({
                    position: wp.location,
                    map: map,
                    label: {
                        text: (i + 1).toString(),
                        color: 'white',
                        fontWeight: 'bold'
                    },
                    title: wp.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: markerColor,
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: 'white'
                    }
                });

                // Thêm sự kiện click
                marker.addListener('click', () => {
                    const content = `
                        <div style="max-width: 220px; padding: 5px; font-family: 'Inter', sans-serif;">
                            <strong style="font-size: 1.1em; color: #1f2937;">${wp.name}</strong>
                            <p style="font-size: 0.9em; margin-top: 5px; color: #4b5563;">${wp.info}</p>
                        </div>`;
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                });
                markers.push(marker);

                // Xử lý marker trùng lặp (Giữ nguyên)
                if (i === 3 && wp.location.lat === planData.waypoints[2].location.lat) {
                     marker.setOptions({
                         optimized: false, 
                         position: {lat: wp.location.lat + 0.0001, lng: wp.location.lng}
                     });
                }
            });
        }

        // --- 7. HÀM ADD PANEL LISTENERS (Giữ nguyên) ---
        function addPanelListeners() {
            const items = document.querySelectorAll('.waypoint-item');
            items.forEach((item) => {
                const index = parseInt(item.dataset.markerIndex, 10);
                if (isNaN(index) || !markers[index]) return; 
                
                const marker = markers[index];

                item.addEventListener('mouseover', (e) => {
                    if (!e.target.classList.contains('thumbnail-img')) {
                         marker.setAnimation(google.maps.Animation.BOUNCE);
                    }
                });
                item.addEventListener('mouseout', () => {
                    marker.setAnimation(null);
                });
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('thumbnail-img')) {
                        google.maps.event.trigger(marker, 'click');
                        map.panTo(marker.getPosition());
                        map.setZoom(16); // Zoom sát hơn
                    }
                });
            });

            const thumbnails = document.querySelectorAll('.thumbnail-img');
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    
                    const photoRef = thumb.dataset.photoref;
                    const largePhotoUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=1600&photoreference=${photoRef}&key=${API_KEY}`;
                    
                    lightboxImg.src = largePhotoUrl; 
                    lightbox.style.display = 'block'; 
                });
            });
        }
        
        // --- 8. HÀM VẼ ĐƯỜNG ĐI (Giữ nguyên) ---
        function calculateAndDisplayRoute(directionsService, directionsRenderer) {
            const waypts = [];
            for (let i = 1; i < planData.waypoints.length - 1; i++) {
                waypts.push({
                    location: planData.waypoints[i].location,
                    stopover: true,
                });
            }
            
            const hasDriving = planData.waypoints.some(wp => wp.transport_mode === '車');
            const transportMode = hasDriving ? 'DRIVING' : 'WALKING';

            directionsService.route({
                origin: planData.waypoints[0].location, 
                destination: planData.waypoints[planData.waypoints.length - 1].location, 
                waypoints: waypts, 
                optimizeWaypoints: false, 
                travelMode: google.maps.TravelMode[transportMode]
            })
            .then((response) => {
                directionsRenderer.setDirections(response);
            })
            .catch((e) => window.alert("Yêu cầu chỉ đường thất bại: " + e));
        }
        
        // --- 9. HÀM TẢI GOOGLE SCRIPT ---
        function loadGoogleMapsScript() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=places`;
                script.async = true;
                document.head.appendChild(script);
            } else {
                // Nếu script đã được tải (ví dụ: do lỗi fetch json)
                initMap();
            }
        }

    </script>
</body>
</html>

