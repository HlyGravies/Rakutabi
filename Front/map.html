<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTrip - Map Result</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body, html { font-family: 'Inter', 'Noto Sans JP', sans-serif; height: 100%; margin: 0; overflow: hidden; }
        
        /* Modal Favorites */
        .fav-panel {
            position: fixed; top: 0; right: -350px; width: 320px; height: 100%;
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 3000; transition: right 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .fav-panel.open { right: 0; }
        
        /* Lightbox */
        .lightbox-overlay { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .lightbox-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90vw; max-height: 90vh; border-radius: 12px; }
        .lightbox-close { position: absolute; top: 20px; right: 35px; color: white; font-size: 40px; cursor: pointer; }
        
        /* Animation cho Weather */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="absolute top-4 right-4 z-20">
        <button id="favBtn" class="bg-white text-orange-600 px-4 py-2 rounded-full shadow-lg font-bold border border-orange-100 hover:bg-orange-50 flex items-center gap-2 transition transform hover:scale-105">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
            „ÅäÊ∞ó„Å´ÂÖ•„Çä
        </button>
    </div>

    <div id="favPanel" class="fav-panel">
        <div class="p-4 border-b flex justify-between items-center bg-orange-50">
            <h2 class="font-bold text-lg text-gray-800">‰øùÂ≠ò„Åó„Åü„É´„Éº„Éà</h2>
            <button id="closeFavBtn" class="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
        </div>
        <div id="favList" class="p-4 overflow-y-auto flex-1 space-y-4 bg-gray-50">
            <p class="text-sm text-gray-500 text-center mt-4">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
    </div>

    <div class="main-container flex w-full h-screen">
        
        <div class="left-panel w-full md:w-2/5 lg:w-1/3 h-full overflow-y-auto bg-white shadow-lg z-10 flex flex-col">
            <div class="p-5 border-b sticky top-0 bg-white z-20 shadow-sm flex justify-between items-center">
                <a href="/" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition">
                    &larr; Êñ∞„Åó„ÅÑÊ§úÁ¥¢
                </a>
                <h1 id="page-title" class="font-bold text-orange-600 text-lg hidden">‚ù§Ô∏è „ÅäÊ∞ó„Å´ÂÖ•„Çä‰∏ÄË¶ß</h1>
            </div>
            
            <div id="left-panel-content" class="flex-1 pb-4">
                <div class="flex justify-center items-center h-64">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                </div>
            </div>

            <div id="add-more-container" class="p-4 border-t bg-gray-50 text-center sticky bottom-0 z-30 hidden">
                <button id="btn-add-more" onclick="handleAddMorePlan()" 
                        class="w-full bg-white border border-orange-200 text-orange-600 font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-orange-50 hover:border-orange-300 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Âà•„ÅÆ„Éó„É©„É≥„ÇíËøΩÂä†ÊèêÊ°à (Add More)
                </button>
                <div id="loading-more" class="hidden text-sm text-orange-600 mt-2 font-medium flex items-center justify-center gap-2">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    AI„ÅåÊñ∞„Åó„ÅÑ„É´„Éº„Éà„ÇíËÄÉ„Åà„Å¶„ÅÑ„Åæ„Åô...
                </div>
            </div>
        </div>

        <div class="right-column hidden md:block w-full h-full relative bg-gray-100">
                
                <div class="map-container absolute inset-0 z-0">
                    <div id="map" class="w-full h-full"></div>
                </div>

                <div id="weather-placeholder" class="absolute top-4 left-4 z-10 w-auto max-w-[90%] shadow-xl transition-all duration-300">
                    </div>
            </div>
        </div>

    <div id="lightbox" class="lightbox-overlay">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

<script>
        // --- C·∫§U H√åNH ---
        const API_KEY = "AIzaSyDRZS3xlk2kHRxjMC1wxKc4y6JUxlzyJts"; 
        const JSON_BASE_PATH = "/json/GeminiAPIResponse/";
        const FAV_COLOR = '#DB2777'; 

        // --- BI·∫æN TO√ÄN C·ª§C ---
        let planData = []; 
        let map; 
        let directionsService;
        let mainRenderers = []; 
        let planMarkers = [];   
        let favOverlays = {}; 
        let loadedJsonCache = {}; 
        let myFavoritesSet = new Set(); 
        const planColors = ['#EA580C', '#3B82F6', '#10B981', '#EC4899', '#8B5CF6']; 

        // --- 1. KH·ªûI T·∫†O MAP ---
        async function initMap() {
            directionsService = new google.maps.DirectionsService();
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12, center: {lat: 35.6895, lng: 139.6917}, 
                mapTypeControl: false, streetViewControl: false, fullscreenControl: false
            });
            
            initLightbox();
            setupFavUI();  
            await loadFavoritesList(false); 

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'favorites') {
                document.getElementById('favBtn').style.display = 'none';
                document.getElementById('page-title').classList.remove('hidden');
                await loadAllFavoritesData();
            } else {
                await loadMainData();
                document.getElementById('add-more-container').classList.remove('hidden');
            }
        }

        // --- 2. LOGIC TH·ªúI TI·∫æT (UPDATED CHO JSON M·ªöI) ---
// --- 2. LOGIC WIDGET TH·ªúI TI·∫æT (ƒê√É KH·ªöP JSON M·ªöI) ---
        let isWeatherOpen = true; 

        function toggleWeatherPanel() {
            const body = document.getElementById('weather-body');
            const icon = document.getElementById('weather-toggle-icon');
            isWeatherOpen = !isWeatherOpen;
            if (isWeatherOpen) {
                body.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                body.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function updateWeather(lat, lng, locationName = "ÁèæÂú®Âú∞") {
            const weatherContainer = document.getElementById('weather-placeholder');
            
            // Style Widget N·ªïi
            weatherContainer.className = "bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-white/50 overflow-hidden transition-all duration-300 flex flex-col";
            weatherContainer.style.maxHeight = "90vh"; 

            // Loading
            weatherContainer.innerHTML = `
                <div class="p-3 flex items-center gap-2 text-gray-500 text-sm font-bold bg-white/80">
                    <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 
                    <span>AI‰∫àÊ∏¨‰∏≠...</span>
                </div>`;

            try {
                const res = await fetch(`/api/weather?lat=${lat}&lng=${lng}`);
                const data = await res.json();

                if (data.success && data.forecasts && data.forecasts.length > 0) {
                    const current = data.forecasts[0]; // Gi·ªù hi·ªán t·∫°i (m·ªõi nh·∫•t)
                    
                    // --- HEADER ---
                    let html = `
                        <div class="p-3 bg-gradient-to-r from-orange-50 to-white flex items-center justify-between cursor-pointer hover:from-orange-100 transition border-b border-gray-100" onclick="toggleWeatherPanel()">
                            <div class="flex items-center gap-3 overflow-hidden pr-2">
                                <div class="bg-white p-1 rounded-full shadow-sm flex-shrink-0">
                                    <img src="${current.icon}" class="w-8 h-8" alt="icon">
                                </div>
                                <div class="min-w-0">
                                    <h3 class="text-sm font-bold text-gray-800 truncate flex items-center gap-1">
                                        ${locationName}
                                    </h3>
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="text-2xl font-black text-gray-800 leading-none">${Math.round(current.weather_info.temperature_C)}¬∞</span>
                                        <span class="text-orange-600 font-medium truncate">${current.weather_info.description}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition">
                                <svg id="weather-toggle-icon" class="h-5 w-5 text-gray-400 transition-transform duration-300" style="transform: rotate(${isWeatherOpen ? '180deg' : '0deg'})" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </div>

                        <div id="weather-body" class="${isWeatherOpen ? '' : 'hidden'} p-3 bg-white/60 transition-all duration-300">
                            <div class="flex overflow-x-auto gap-3 pb-2 scrollbar-thin">`;

                    // --- LOOP C√ÅC M·ªêC GI·ªú ---
                    data.forecasts.forEach(item => {
                        // Badge Ng√†y
                        let dateClass = "bg-gray-100 text-gray-500";
                        if(item.date_label === "‰ªäÊó•") dateClass = "bg-orange-500 text-white shadow-sm";
                        if(item.date_label === "ÊòéÊó•") dateClass = "bg-blue-500 text-white shadow-sm";

                        // X·ª≠ l√Ω list (N·ªëi m·∫£ng th√†nh chu·ªói)
                        const clothesFull = (item.clothing_suggestions_jp && item.clothing_suggestions_jp.length > 0) 
                                            ? item.clothing_suggestions_jp.join('„Éª') 
                                            : "Áâπ„Å´„Å™„Åó";
                        
                        const healthFull = (item.health_warnings_jp && item.health_warnings_jp.length > 0)
                                           ? item.health_warnings_jp.join('<br>') 
                                           : "Âø´ÈÅ©„Åß„Åô";

                        // L·∫•y 1 m√≥n ƒë·ªì ƒë·∫°i di·ªán
                        const clothesShort = (item.clothing_suggestions_jp && item.clothing_suggestions_jp.length > 0)
                                             ? item.clothing_suggestions_jp[0] 
                                             : '-';

                        html += `
                            <div class="flex-shrink-0 w-32 h-44 bg-white rounded-xl border border-gray-100 relative group overflow-hidden shadow-sm hover:shadow-lg transition-all transform hover:-translate-y-1">
                                
                                <div class="absolute inset-0 flex flex-col items-center justify-between p-2 transition-opacity duration-300 group-hover:opacity-0">
                                    <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${dateClass}">${item.date_label}</span>
                                    
                                    <div class="text-center">
                                        <span class="text-xs font-bold text-gray-400 block">${item.weather_info.hour}</span>
                                        <img src="${item.icon}" class="w-10 h-10 mx-auto drop-shadow-sm" alt="icon">
                                    </div>

                                    <span class="text-xl font-bold text-gray-800">${Math.round(item.weather_info.temperature_C)}¬∞</span>
                                    
                                    <div class="w-full text-center border-t border-dashed border-gray-100 pt-1">
                                        <p class="text-[10px] text-orange-500 truncate font-medium">üëï ${clothesShort}</p>
                                    </div>
                                </div>

                                <div class="absolute inset-0 bg-white/95 p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 overflow-y-auto scrollbar-none text-left">
                                    <div class="mb-2 border-b border-gray-100 pb-1">
                                        <p class="text-[9px] font-bold text-gray-400">TIME</p>
                                        <p class="text-xs font-bold text-gray-800">${item.date_label} ${item.weather_info.hour}</p>
                                    </div>
                                    <div class="mb-2">
                                        <p class="text-[9px] font-bold text-orange-500">CLOTHING</p>
                                        <p class="text-[10px] text-gray-600 leading-tight">${clothesFull}</p>
                                    </div>
                                    <div>
                                        <p class="text-[9px] font-bold text-red-500">HEALTH</p>
                                        <p class="text-[10px] text-gray-600 leading-tight">${healthFull}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `   </div>
                                <div class="flex justify-between items-center mt-2 px-1">
                                    <div class="flex items-center gap-2 text-[10px] text-gray-400">
                                        <span>‚òî ${current.weather_info.humidity_percent}%</span>
                                        <span>UV: ${current.weather_info.uv_index}</span>
                                    </div>
                                </div>
                            </div>`;

                    weatherContainer.innerHTML = html;
                } else {
                    weatherContainer.innerHTML = '<div class="p-3 text-sm text-red-500 bg-white rounded-lg">Â§©Ê∞óÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                }
            } catch (e) {
                console.error(e);
                weatherContainer.innerHTML = '<div class="p-3 text-sm text-red-500 bg-white rounded-lg">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
            }
        }
        async function loadMainData() {
            const urlParams = new URLSearchParams(window.location.search);
            let jsonPath = urlParams.get('planFile');
            if (!jsonPath) { document.getElementById('left-panel-content').innerHTML = ''; return; }
            if (!jsonPath.includes('/')) jsonPath = JSON_BASE_PATH + jsonPath;

            try {
                const res = await fetch(jsonPath);
                const data = await res.json();
                
                if (Array.isArray(data)) planData = planData.concat(data);
                else planData.push(data);

                const filename = jsonPath.split('/').pop();
                loadedJsonCache[filename] = data; 

                populateLeftPanel(); 
                drawMainRoutes(); 
                
                setTimeout(() => {
                    const allDetails = document.querySelectorAll('details');
                    if (allDetails.length > 0) {
                        const firstDetail = allDetails[0];
                        firstDetail.open = true;
                        window.onRouteToggle(firstDetail, 0); 
                    }
                }, 800);

            } catch (e) { console.error(e); }
        }

        async function loadAllFavoritesData() {
            try {
                const res = await fetch('/api/favorites');
                const data = await res.json();
                if (!data.success || data.favorites.length === 0) {
                    document.getElementById('left-panel-content').innerHTML = `<div class="p-10 text-center text-gray-500"><p>„Åæ„Å†„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„É´„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p><a href="/" class="text-orange-600 hover:underline mt-2 block">Êñ∞„Åó„ÅÑ„Éó„É©„É≥„Çí‰ΩúÊàê„Åô„Çã</a></div>`;
                    return;
                }
                const promises = data.favorites.map(async (fav) => {
                    let jsonData = loadedJsonCache[fav.file_path];
                    if (!jsonData) {
                        try {
                            const r = await fetch(JSON_BASE_PATH + fav.file_path);
                            if (!r.ok) return null;
                            jsonData = await r.json();
                            loadedJsonCache[fav.file_path] = jsonData;
                        } catch (e) { return null; }
                    }
                    if (jsonData) {
                        const list = Array.isArray(jsonData) ? jsonData : [jsonData];
                        const specificPlan = list.find(p => p.plan_title === fav.plan_title);
                        if (specificPlan) {
                            specificPlan._sourceFileName = fav.file_path;
                            return specificPlan;
                        }
                    }
                    return null;
                });
                const results = await Promise.all(promises);
                planData = results.filter(p => p !== null);
                populateLeftPanel();
                drawMainRoutes();

                setTimeout(() => {
                    const allDetails = document.querySelectorAll('details');
                    if (allDetails.length > 0) {
                        const firstDetail = allDetails[0];
                        firstDetail.open = true;
                        window.onRouteToggle(firstDetail, 0);
                    }
                }, 800);

            } catch (e) { console.error(e); }
        }

        // --- 4. RENDER UI C·ªòT TR√ÅI (GI·ªÆ NGUY√äN) ---
        function populateLeftPanel() {
            const panel = document.getElementById('left-panel-content');
            let html = '';
            planData.forEach((plan, idx) => {
                const color = planColors[idx % planColors.length];
                const currentFileName = plan._sourceFileName || getCurrentFilename();
                const isFav = myFavoritesSet.has(`${currentFileName}|${plan.plan_title}`);
                const heartClass = isFav ? "text-pink-500 bg-pink-100 hover:bg-pink-200" : "text-gray-400 hover:text-pink-500 hover:bg-pink-50";

                html += `
                    <details class="group border-b border-gray-200 transition-all duration-300" 
                             ontoggle="onRouteToggle(this, ${idx})">
                        <summary class="p-5 cursor-pointer hover:bg-gray-50 flex justify-between items-start list-none select-none">
                            <div class="border-l-4 pl-3 transition-colors duration-300 flex-1" style="border-color:${color}">
                                <h2 class="font-bold text-gray-900 text-lg group-open:text-orange-700">${plan.plan_title}</h2>
                                <p class="text-xs text-gray-500 mt-1">${plan.summary || ''}</p>
                            </div>
                            <button onclick="toggleFavorite(event, '${plan.plan_title}', '${currentFileName}')" 
                                    class="ml-2 transition p-2 rounded-full ${heartClass} shrink-0" 
                                    title="${isFav ? '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§' : '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´‰øùÂ≠ò'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            </button>
                        </summary>
                        <div class="bg-white p-4 space-y-6">
                            ${plan.waypoints.map((wp, i) => `
                                <div class="flex gap-4 text-sm relative">
                                    <div class="flex flex-col items-center">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm" style="background-color:${color}">${i+1}</div>
                                        ${i !== plan.waypoints.length - 1 ? `<div class="w-0.5 h-full bg-gray-200 my-1"></div>` : ''}
                                    </div>
                                    <div class="pb-2 w-full">
                                        <span class="text-xs font-semibold text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full border border-orange-100 mb-1 inline-block">${wp.activity ? wp.activity : 'Activity'}</span>
                                        <p class="font-bold text-gray-800 text-base">${wp.name}</p>
                                        <p class="text-gray-600 text-xs mt-1 leading-relaxed">${wp.info}</p>
                                        ${wp.photo_references && wp.photo_references.length > 0 ? `
                                            <div class="flex gap-2 mt-3 overflow-x-auto pb-2 scrollbar-hide">
                                                ${wp.photo_references.slice(0, 3).map(ref => `
                                                    <img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${ref}&key=${API_KEY}" 
                                                         class="w-16 h-16 object-cover rounded-md shadow-sm cursor-pointer hover:opacity-80 transition shrink-0"
                                                         onclick="openLightbox(this.src.replace('maxwidth=200', 'maxwidth=1600'))">
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
            });
            panel.innerHTML = html;
        }

        // --- 5. LOGIC V·∫º MAP (GI·ªÆ NGUY√äN) ---
        function drawMainRoutes() {
            mainRenderers.forEach(r => r && r.setMap(null));
            mainRenderers = [];
            planMarkers.forEach(markerArr => markerArr && markerArr.forEach(m => m.setMap(null)));
            planMarkers = [];

            planData.forEach((plan, idx) => {
                const color = planColors[idx % planColors.length];
                const renderer = new google.maps.DirectionsRenderer({
                    map: null, suppressMarkers: true,
                    polylineOptions: { strokeColor: color, strokeWeight: 6, strokeOpacity: 0.8 }
                });
                mainRenderers.push(renderer);

                const currentMarkers = [];
                plan.waypoints.forEach((wp, i) => {
                    const marker = new google.maps.Marker({
                        position: wp.location, map: null, 
                        label: { text: (i + 1).toString(), color: 'white', fontWeight: 'bold' },
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 14, fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: 'white' },
                        zIndex: 100 + i, title: wp.name
                    });
                    marker.addListener("click", () => {
                        new google.maps.InfoWindow({
                            content: `<div style="padding:5px"><h3 style="font-weight:bold">${wp.name}</h3><p style="font-size:12px">${wp.info}</p></div>`
                        }).open(map, marker);
                    });
                    currentMarkers.push(marker);
                });
                planMarkers.push(currentMarkers);

                const wps = plan.waypoints;
                if(wps.length >= 2) {
                    const waypts = wps.slice(1, -1).map(wp => ({ location: wp.location, stopover: true }));
                    directionsService.route({
                        origin: wps[0].location, destination: wps[wps.length-1].location,
                        waypoints: waypts, travelMode: google.maps.TravelMode.DRIVING 
                    }, (res, status) => {
                        if (status === 'OK') renderer.setDirections(res);
                    });
                }
            });
        }

        // --- 6. H√ÄM TOGGLE (QUAN TR·ªåNG) ---
        window.onRouteToggle = function(detailsElement, index) {
            const isOpen = detailsElement.open;
            if(isOpen) {
                document.querySelectorAll('details').forEach((el, i) => { if(i !== index && el.open) el.open = false; });
                mainRenderers.forEach(r => r && r.setMap(null));
                planMarkers.forEach(arr => arr && arr.forEach(m => m.setMap(null)));
            }
            if (mainRenderers[index]) mainRenderers[index].setMap(isOpen ? map : null);
            if (planMarkers[index]) planMarkers[index].forEach(m => m.setMap(isOpen ? map : null));

            if (isOpen && mainRenderers[index] && mainRenderers[index].getDirections()) {
                const routeBounds = mainRenderers[index].getDirections().routes[0].bounds;
                map.fitBounds(routeBounds);
            }

            // G·ªåI API TH·ªúI TI·∫æT KHI M·ªû
            if (isOpen && planData[index]) {
                const plan = planData[index];
                if (plan.waypoints && plan.waypoints.length > 0) {
                    const firstPoint = plan.waypoints[0];
                    const displayLocationName = plan.region_name || firstPoint.name;
                    updateWeather(firstPoint.location.lat, firstPoint.location.lng, displayLocationName);
                }
            }
        };

        // --- 7. ADD MORE & POLLING (GI·ªÆ NGUY√äN) ---
        async function handleAddMorePlan() {
            const storedInput = localStorage.getItem('last_trip_request');
            const storedMapFile = localStorage.getItem('last_map_file');
            if (!storedInput) return alert("ÂÖÉ„ÅÆÊ§úÁ¥¢„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ");

            const requestData = JSON.parse(storedInput);
            if (storedMapFile) requestData.existing_map_path = storedMapFile;

            const btn = document.getElementById('btn-add-more');
            const loading = document.getElementById('loading-more');
            btn.classList.add('hidden'); loading.classList.remove('hidden');

            try {
                const res = await fetch('/api/start-job', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                const data = await res.json();
                if (data.success) await pollForNewPlan(data.job_id);
                else throw new Error(data.error);
            } catch (err) {
                alert("„Ç®„É©„Éº: " + err.message);
                btn.classList.remove('hidden'); loading.classList.add('hidden');
            }
        }

        async function pollForNewPlan(jobId) {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/check-status?job_id=${jobId}`);
                    const data = await res.json();
                    
                    if (data.data.status === 'complete') {
                        clearInterval(interval);
                        const newPlanRes = await fetch(data.data.planFile);
                        const newPlanJson = await newPlanRes.json();
                        if (Array.isArray(newPlanJson)) planData = planData.concat(newPlanJson);
                        else planData.push(newPlanJson);

                        populateLeftPanel(); drawMainRoutes();
                        setTimeout(() => {
                            const allDetails = document.querySelectorAll('details');
                            const lastDetail = allDetails[allDetails.length - 1];
                            if(lastDetail) {
                                lastDetail.open = true;
                                window.onRouteToggle(lastDetail, allDetails.length - 1);
                            }
                        }, 500);
                        document.getElementById('btn-add-more').classList.remove('hidden');
                        document.getElementById('loading-more').classList.add('hidden');
                    } else if (data.data.status === 'error') {
                        clearInterval(interval);
                        alert("‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                        document.getElementById('btn-add-more').classList.remove('hidden');
                        document.getElementById('loading-more').classList.add('hidden');
                    }
                } catch (e) { console.error(e); }
            }, 3000);
        }

        function getCurrentFilename() {
            const urlParams = new URLSearchParams(window.location.search);
            const fullPath = urlParams.get('planFile'); 
            if(!fullPath) return null;
            return fullPath.split('/').pop();
        }

        // --- 8. FAVORITES & UTILS (GI·ªÆ NGUY√äN) ---
        window.toggleFavorite = async function(e, title, filenameOverride) {
            e.preventDefault(); e.stopPropagation();
            const filename = filenameOverride || getCurrentFilename();
            if(!filename) return alert("„Éï„Ç°„Ç§„É´„Ç®„É©„Éº");
            const key = `${filename}|${title}`;
            const isCurrentlyFav = myFavoritesSet.has(key);
            const btn = e.currentTarget;
            const apiUrl = isCurrentlyFav ? '/api/favorites/delete' : '/api/favorites/add';
            try {
                const res = await fetch(apiUrl, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ file_path: filename, plan_title: title })
                });
                const data = await res.json();
                if(data.success) {
                    if (isCurrentlyFav) {
                        myFavoritesSet.delete(key);
                        btn.className = "ml-2 transition p-2 rounded-full text-gray-400 hover:text-pink-500 hover:bg-pink-50 shrink-0";
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('mode') === 'favorites') loadAllFavoritesData();
                    } else {
                        myFavoritesSet.add(key);
                        btn.className = "ml-2 transition p-2 rounded-full text-pink-500 bg-pink-100 hover:bg-pink-200 shrink-0";
                    }
                    loadFavoritesList(true);
                } else { alert('„Ç®„É©„Éº: ' + data.message); }
            } catch(err) { console.error(err); }
        };

        window.deleteFromPanel = async function(filename, title) { /* Logic x√≥a panel (nh∆∞ c≈©) */
            try {
                const res = await fetch('/api/favorites/delete', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ file_path: filename, plan_title: title })
                });
                const data = await res.json();
                if(data.success) {
                    myFavoritesSet.delete(`${filename}|${title}`);
                    await loadFavoritesList(true);
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('mode') === 'favorites') loadAllFavoritesData();
                    else populateLeftPanel();
                    if (favOverlays[title]) { favOverlays[title].setMap(null); delete favOverlays[title]; }
                }
            } catch(err) { console.error(err); }
        };

        async function loadFavoritesList(shouldRenderPanel = true) { /* Logic load list (nh∆∞ c≈©) */ 
            const listDiv = document.getElementById('favList');
            try {
                const res = await fetch('/api/favorites');
                const data = await res.json();
                myFavoritesSet.clear();
                if(data.success) data.favorites.forEach(fav => myFavoritesSet.add(`${fav.file_path}|${fav.plan_title}`));
                if (!shouldRenderPanel) return;
                if(!data.success || data.favorites.length === 0) {
                    listDiv.innerHTML = `<p class="text-sm text-gray-400 text-center mt-4">„Åæ„Å†‰øùÂ≠ò„Åï„Çå„Åü„É´„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>`;
                    return;
                }
                listDiv.innerHTML = data.favorites.map(fav => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition group relative">
                        <button onclick="deleteFromPanel('${fav.file_path}', '${fav.plan_title}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 z-10">&times;</button>
                        <div class="flex items-start gap-3">
                            <div class="pt-1"><input class="w-5 h-5 accent-pink-500 cursor-pointer" onchange="toggleOverlayRoute(this, '${fav.file_path}', '${fav.plan_title}')"></div>
                            <div class="flex-1 min-w-0 pr-6">
                                <h3 class="font-bold text-sm text-gray-800 truncate">${fav.plan_title}</h3>
                                <p class="text-xs text-gray-400 mt-0.5">${new Date(fav.created_at).toLocaleDateString()}</p>
                                <a href="/map?planFile=${fav.file_path}&planTitle=${encodeURIComponent(fav.plan_title)}" class="text-xs text-orange-600 font-medium hover:text-orange-800 mt-2 inline-flex items-center">„Åì„ÅÆ„É´„Éº„Éà„Å†„ÅëË¶ã„Çã &rarr;</a>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch(err) { console.error(err); }
        }

        window.toggleOverlayRoute = async function(checkbox, filename, planTitle) { /* Logic overlay (nh∆∞ c≈©) */
            if (!checkbox.checked) {
                if (favOverlays[planTitle]) { favOverlays[planTitle].setMap(null); delete favOverlays[planTitle]; }
                return;
            }
            let data = loadedJsonCache[filename];
            if (!data) {
                try {
                    const res = await fetch(JSON_BASE_PATH + filename);
                    data = await res.json();
                    loadedJsonCache[filename] = data; 
                } catch (e) { alert("„Éá„Éº„Çø„Ç®„É©„Éº"); checkbox.checked = false; return; }
            }
            const list = Array.isArray(data) ? data : [data];
            const targetPlan = list.find(p => p.plan_title === planTitle);
            if (!targetPlan) return alert("„Éó„É©„É≥„Å™„Åó");

            const renderer = new google.maps.DirectionsRenderer({
                map: map, suppressMarkers: false,
                polylineOptions: { strokeColor: FAV_COLOR, strokeWeight: 6, strokeOpacity: 1.0, zIndex: 999 }
            });
            const wps = targetPlan.waypoints;
            const waypts = wps.slice(1, -1).map(wp => ({ location: wp.location, stopover: true }));
            directionsService.route({
                origin: wps[0].location, destination: wps[wps.length-1].location,
                waypoints: waypts, travelMode: google.maps.TravelMode.DRIVING
            }, (res, status) => {
                if (status === 'OK') {
                    renderer.setDirections(res);
                    favOverlays[planTitle] = renderer;
                    const bounds = map.getBounds() || new google.maps.LatLngBounds();
                    res.routes[0].bounds.union(bounds); map.fitBounds(bounds);
                } else checkbox.checked = false;
            });
        };

        function setupFavUI() {
            const btn = document.getElementById('favBtn');
            const panel = document.getElementById('favPanel');
            const close = document.getElementById('closeFavBtn');
            btn.onclick = () => { panel.classList.add('open'); loadFavoritesList(true); };
            close.onclick = () => panel.classList.remove('open');
        }

        function initLightbox() { 
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            document.querySelector('.lightbox-close').onclick = () => lb.style.display = 'none';
            lb.onclick = (e) => { if(e.target === lb) lb.style.display = 'none'; };
            window.openLightbox = (src) => { img.src = src; lb.style.display = 'block'; }
        }

        function loadGoogleMapsScript() {
            if (typeof google === 'undefined') {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=places`;
                script.async = true;
                document.body.appendChild(script);
            } else initMap();
        }
        loadGoogleMapsScript();

    </script>
</body>
</html>