<!DOCTYPE html>
<html>
<head>
    <title>Kế Hoạch Mini Trip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS CƠ BẢN (Giữ nguyên) */
        html, body {
            height: 100%; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f4f4;
        }
        .main-container {
            display: flex; width: 100vw; height: 100vh;
        }
        .left-panel {
            flex-basis: 40%; height: 100vh; overflow-y: auto;
            background-color: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10;
        }
        .right-panel {
            flex-basis: 60%; height: 100vh;
        }
        #map {
            height: 100%; width: 100%;
        }
        
        /* CSS cho nội dung bên trái (Giữ nguyên) */
        .trip-header { padding: 20px 25px; border-bottom: 1px solid #eee; }
        .trip-header h1 { margin: 0 0 5px 0; font-size: 1.5em; color: #333; }
        .trip-header p { margin: 0; font-size: 0.9em; color: #666; }
        .waypoints-list { padding: 0; margin: 0; }
        .waypoint-item {
            display: flex; padding: 20px 25px; border-bottom: 1px solid #eee;
            align-items: flex-start; cursor: pointer; /* <-- MỚI: Thêm con trỏ */
            transition: background-color 0.2s; /* <-- MỚI: Hiệu ứng hover */
        }
        .waypoint-item:hover { /* <-- MỚI: Highlight khi hover */
            background-color: #f9f9f9;
        }
        .waypoint-order {
            font-size: 1.2em; font-weight: bold; color: #007bff;
            margin-right: 20px; padding-top: 5px;
        }
        .waypoint-details h3 { margin: 0 0 8px 0; font-size: 1.1em; color: #111; }
        .waypoint-details .activity {
            font-size: 0.85em; font-weight: 600; color: #888;
            background-color: #f0f0f0; padding: 3px 8px; border-radius: 4px;
            display: inline-block; margin-bottom: 10px;
        }
        .waypoint-details .info { margin: 0; font-size: 0.95em; line-height: 1.5; color: #555; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="left-panel" id="left-panel">
            </div>
        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>

    <script>
        // --- 1. DỮ LIỆU KẾ HOẠCH (Giữ nguyên) ---
        const planData = {
            "plan_title": "大阪グルメミニ旅行：ラーメンとカフェ巡り",
            "theme": "ラーメン、カフェ",
            "estimated_duration_hours": 5.5,
            "waypoints": [
                { "order": 1, "name": "麺道しゅはり 伊丹店", "activity": "昼食", "location": { "lat": 34.7832275, "lng": 135.3984564 }, "info": "ラーメンEXPOでグランプリを受賞した人気店...", "transport_mode": "車" },
                { "order": 2, "name": "大阪城", "activity": "観光", "location": { "lat": 34.6872571, "lng": 135.5 }, "info": "大阪のシンボルである大阪城を観光します...", "transport_mode": "車" },
                { "order": 3, "name": "本町製麺所 中華そば工房", "activity": "カフェ/休憩", "location": { "lat": 34.6817207, "lng": 135.5081192 }, "info": "大阪の食通に愛され、格式高いビブグルマンにも選出された店...", "transport_mode": "車" },
                { "order": 4, "name": "どうとんぼり神座 心斎橋長堀店", "activity": "軽食", "location": { "lat": 34.6748295, "lng": 135.501165 }, "info": "あっさりしながらも深いコクのあるスープが特徴...", "transport_mode": "徒歩" }
            ],
            "summary": "大阪で美味しいラーメンとカフェを楽しむ3時間のミニ旅行です..."
        };

        // --- 2. BIẾN TOÀN CỤC CHO BẢN ĐỒ ---
        let map; // <-- MỚI
        let markers = []; // <-- MỚI: Mảng để chứa các marker
        let infowindow; // <-- MỚI: Cửa sổ thông tin chung

        // --- 3. HÀM ĐỔ DỮ LIỆU CỘT TRÁI (Giữ nguyên) ---
        function populateLeftPanel() {
            const panel = document.getElementById('left-panel');
            let content = '';
            content += `<div class="trip-header"><h1>${planData.plan_title}</h1><p>${planData.summary}</p></div>`;
            content += '<div class="waypoints-list">';
            planData.waypoints.forEach(wp => {
                content += `
                    <div class="waypoint-item">
                        <div class="waypoint-order">${wp.order}</div>
                        <div class="waypoint-details">
                            <span class="activity">${wp.activity}</span>
                            <h3>${wp.name}</h3>
                            <p class="info">${wp.info}</p>
                        </div>
                    </div>
                `;
            });
            content += '</div>';
            panel.innerHTML = content;
        }

        // --- 4. HÀM KHỞI TẠO BẢN ĐỒ (Cập nhật) ---
        function initMap() {
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true // <-- MỚI: Tắt marker A, B, C, D mặc định
            });
            
            const firstLocation = planData.waypoints[0].location;

            map = new google.maps.Map(document.getElementById("map"), { // <-- MỚI: Gán vào biến global
                zoom: 12,
                center: firstLocation
            });

            directionsRenderer.setMap(map);
            infowindow = new google.maps.InfoWindow(); // <-- MỚI: Khởi tạo InfoWindow

            // --- MỚI: Thêm các marker tùy chỉnh ---
            addMarkers();

            // --- MỚI: Thêm tương tác cho cột trái ---
            addPanelListeners();
            
            // --- Vẽ đường đi (như cũ) ---
            calculateAndDisplayRoute(directionsService, directionsRenderer);
        }

        // --- 5. HÀM MỚI: THÊM MARKERS TÙY CHỈNH ---
        function addMarkers() {
            planData.waypoints.forEach((wp, i) => {
                const marker = new google.maps.Marker({
                    position: wp.location,
                    map: map,
                    label: (i + 1).toString(), // Đánh số 1, 2, 3, 4
                    title: wp.name
                });

                // Event: Click vào marker -> Mở InfoWindow
                marker.addListener('click', () => {
                    const content = `
                        <div style="max-width: 200px;">
                            <strong style="font-size: 1.1em;">${wp.name}</strong>
                            <p style="font-size: 0.9em; margin-top: 5px;">Hoạt động: ${wp.activity}</p>
                        </div>`;
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                });

                markers.push(marker); // Lưu marker vào mảng
            });
        }

        // --- 6. HÀM MỚI: THÊM TƯƠNG TÁC 2 CHIỀU ---
        function addPanelListeners() {
            const items = document.querySelectorAll('.waypoint-item');
            
            items.forEach((item, i) => {
                const marker = markers[i]; // Lấy marker tương ứng

                // Event: Hover vào text -> Marker nảy lên
                item.addEventListener('mouseover', () => {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                });
                
                // Event: Rời chuột khỏi text -> Marker ngừng nảy
                item.addEventListener('mouseout', () => {
                    marker.setAnimation(null);
                });
                
                // Event: Click vào text -> Kích hoạt event click của marker
                item.addEventListener('click', () => {
                    google.maps.event.trigger(marker, 'click');
                    // Tùy chọn: Tự động di chuyển bản đồ tới marker
                    map.panTo(marker.getPosition());
                    map.setZoom(15); // Zoom vào
                });
            });
        }

        // --- 7. HÀM VẼ ĐƯỜNG ĐI (Giữ nguyên) ---
        function calculateAndDisplayRoute(directionsService, directionsRenderer) {
            const waypts = [];
            for (let i = 1; i < planData.waypoints.length - 1; i++) {
                waypts.push({
                    location: planData.waypoints[i].location,
                    stopover: true,
                });
            }
            
            const hasDriving = planData.waypoints.some(wp => wp.transport_mode === '車');
            const transportMode = hasDriving ? 'DRIVING' : 'WALKING';

            directionsService.route({
                origin: planData.waypoints[0].location,
                destination: planData.waypoints[planData.waypoints.length - 1].location,
                waypoints: waypts,
                optimizeWaypoints: false, 
                travelMode: google.maps.TravelMode[transportMode]
            })
            .then((response) => {
                directionsRenderer.setDirections(response);
            })
            .catch((e) => window.alert("Yêu cầu chỉ đường thất bại: " + e));
        }

        // --- 8. CHẠY CÁC HÀM ---
        populateLeftPanel(); 
        
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmbdRFOMwNlwiUD-LEwTvvJ6Twb0JlpmU&callback=initMap">
    </script>
    </body>
</html>