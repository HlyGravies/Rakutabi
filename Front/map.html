<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTrip - Kết quả</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body, html {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* CSS CHO LIGHTBOX (Giữ nguyên) */
        .lightbox-overlay {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            overflow: auto; 
            backdrop-filter: blur(8px);
        }
        .lightbox-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
            max-width: 90vw; 
            max-height: 90vh; 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #ffffff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .lightbox-close:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="main-container flex w-full h-screen">
        
        <div class="left-panel w-full md:w-2/5 lg:w-1/3 h-full overflow-y-auto bg-white shadow-lg z-10">
            <div class="p-5 border-b sticky top-0 bg-white z-20">
                <!-- SỬA: Trỏ về trang chủ (do Flask phục vụ) -->
                <a href="/" id="backButton" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-orange-500 transition duration-200">
                    <svg class="-ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 010 1.06L9.06 10l3.73 3.71a.75.75 0 11-1.06 1.06l-4.25-4.25a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 0z" clip-rule="evenodd" />
                    </svg>
                    新しい検索
                </a>
            </div>
            <div id="left-panel-content">
                <!-- JS sẽ đổ kế hoạch vào đây -->
            </div>
        </div>

        <div class="right-column hidden md:block flex-grow h-full bg-gray-100 p-4">
            
            <div class="flex flex-col h-full space-y-4">
            
                <div id="weather-placeholder" class="h-48 flex-shrink-0 bg-white rounded-lg shadow-lg p-5">
                    <h3 class="text-lg font-semibold text-gray-700">Góc Thời Tiết (Sắp có)</h3>
                    <p class="text-gray-500 mt-2">Khu vực này sẽ hiển thị thông tin thời tiết cho chuyến đi của bạn.</p>
                </div>

                <div class="map-container flex-grow rounded-lg shadow-lg overflow-hidden">
                    <div id="map"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="lightbox" class="lightbox-overlay">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <script>
        // --- 0. Đặt API Key của bạn ở đây ---
        // ⚠️ Nhớ thay API Key của bạn vào đây
        const API_KEY = "AIzaSyAmbdRFOMwNlwiUD-LEwTvvJ6Twb0JlpmU"; 

        // --- 1. BIẾN TOÀN CỤC ---
        let planData; 
        let map; 
        let markers = [];
        let infowindow;
        let lightbox;
        let lightboxImg;
        let lightboxClose;
        let directionsService;
        let routeRenderers = []; 
        const planColors = ['#EA580C', '#3B82F6', '#10B981', '#F59E0B', '#6366F1'];

        // --- 2. TẢI DỮ LIỆU TỪ FILE JSON (ĐÃ SỬA) ---
        
        // 1. Lấy (GET) tham số 'planFile' từ URL
        // (Đây là đường dẫn /json/Gemini... mà input.html đã chuyển đến)
        const urlParams = new URLSearchParams(window.location.search);
        const dynamicJsonPath = urlParams.get('planFile'); 

        if (!dynamicJsonPath) {
            // Xử lý lỗi nếu không tìm thấy
            console.error("Không tìm thấy 'planFile' trong URL.");
            document.body.innerHTML = `<div class="p-10">
                <h1 class="text-2xl font-bold text-red-600">Lỗi: Không tìm thấy dữ liệu kế hoạch</h1>
                <p class="mt-2 text-gray-700">Bạn có thể đã truy cập trực tiếp trang này. Vui lòng tạo một kế hoạch mới.</p>
                <!-- SỬA: Trỏ về trang chủ (do Flask phục vụ) -->
                <a href="/" class="mt-4 inline-block px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700">Tạo kế hoạch mới</a>
            </div>`;
        } else {
            // 2. Dùng đường dẫn động để fetch
            // Đường dẫn này là tương đối (ví dụ: /json/GeminiAPIResponse/...)
            // nên nó sẽ tự động gọi server 5000 (nơi đang phục vụ trang này)
            console.log("Đang tải file kế hoạch:", dynamicJsonPath);
            
            fetch(dynamicJsonPath) // <-- SỬ DỤNG BIẾN ĐỘNG
                .then(response => {
                    if (!response.ok) {
                        // Nếu file không tìm thấy (lỗi 404)
                        throw new Error(`HTTP error! status: ${response.status} - Không tìm thấy file: ${dynamicJsonPath}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        throw new Error("Dữ liệu JSON không phải là một mảng hoặc bị rỗng.");
                    }
                    planData = data; 
                    populateLeftPanel(); 
                    loadGoogleMapsScript(); // Chỉ tải Google Maps SAU KHI có data
                })
                .catch(error => {
                    console.error("Lỗi tải file JSON:", error);
                    document.body.innerHTML = `<div class="p-10">
                        <h1 class="text-2xl font-bold text-red-600">Lỗi: Không tải được file JSON</h1>
                        <p class="mt-2 text-gray-700">${error.message}</p>
                        <!-- SỬA: Trỏ về trang chủ (do Flask phục vụ) -->
                        <a href="/" class="mt-4 inline-block px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700">Quay lại</a>
                    </div>`;
                });
        }
        // === KẾT THÚC SỬA ĐỔI ===
        
        
        // --- 3. HÀM ĐỔ DỮ LIỆU CỘT TRÁI (Giữ nguyên) ---
        function populateLeftPanel() {
            const panel = document.getElementById('left-panel-content');
            let content = '';
            
            planData.forEach((plan, planIndex) => {
                const planColor = planColors[planIndex % planColors.length];

                content += `
                    <details class="plan-dropdown border-b border-gray-200" data-plan-index="${planIndex}" ${planIndex === 0 ? 'open' : ''}> <!-- Mở sẵn kế hoạch đầu tiên -->
                        <summary class="plan-summary p-5 cursor-pointer hover:bg-gray-100 transition duration-200 flex justify-between items-center" style="border-left: 5px solid ${planColor};">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">${plan.plan_title}</h2>
                                <p class="text-sm text-gray-600 mt-1">${plan.summary}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-500 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </summary>

                        <div class="waypoints-list divide-y divide-gray-200 bg-gray-50">
                `;
                
                plan.waypoints.forEach((wp, waypointIndex) => {
                    let activityColor = 'bg-orange-100 text-orange-700';
                    if (wp.activity.includes("サプライズ") || wp.activity.includes("おまかせ")) {
                        activityColor = 'bg-purple-100 text-purple-700';
                    }

                    content += `
                        <div class="waypoint-item p-5 cursor-pointer transition duration-200 hover:bg-orange-50" 
                             data-plan-index="${planIndex}" 
                             data-waypoint-index="${waypointIndex}">
                            <div class="flex items-start">
                                <div class="waypoint-order text-xl font-bold mr-4 pt-1" style="color: ${planColor};">${wp.order}</div>
                                <div class="waypoint-details flex-1">
                                    <span class="activity text-xs font-semibold ${activityColor} rounded-full px-3 py-1 inline-block mb-3">${wp.activity}</span>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${wp.name}</h3>
                                    <p class="info text-sm text-gray-600 leading-relaxed">${wp.info}</p>
                                    ${createPhotoGallery(wp.photo_references)} 
                                </div>
                            </div>
                        </div>
                    `;
                });

                content += '</div></details>'; 
            });

            panel.innerHTML = content;
        }

        // --- 3.5. HÀM TẠO GALLERY (Giữ nguyên) ---
        function createPhotoGallery(references) {
            if (!Array.isArray(references) || references.length === 0) {
                return ''; 
            }
            const refArray = references.slice(0, 5); 
            let galleryHTML = '<div class="photo-gallery mt-4 flex flex-wrap gap-2">';
            refArray.forEach(ref => {
                if (ref) { 
                    const thumbnailUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${ref}&key=${API_KEY}`;
                    galleryHTML += `
                        <img src="${thumbnailUrl}" 
                             class="thumbnail-img w-20 h-20 object-cover rounded-md cursor-pointer transition duration-200 hover:opacity-80 hover:scale-105" 
                             data-photoref="${ref}" 
                             alt="Ảnh địa điểm"
                             onerror="this.style.display='none'"> 
                    `;
                }
            });
            galleryHTML += '</div>';
            return galleryHTML;
        }

        // --- 4. HÀM INIT MAP (Giữ nguyên) ---
        function initMap() {
            directionsService = new google.maps.DirectionsService();
            
            const firstLocation = planData[0].waypoints[0].location;
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: firstLocation,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });
            
            infowindow = new google.maps.InfoWindow();

            initLightbox();
            addMarkers(); 
            addPanelListeners(); 
            createAllRouteRenderers(); 
        }

        // --- 5. HÀM INIT LIGHTBOX (Giữ nguyên) ---
        function initLightbox() {
            lightbox = document.getElementById('lightbox');
            lightboxImg = document.getElementById('lightbox-img');
            lightboxClose = document.querySelector('.lightbox-close');

            lightboxClose.addEventListener('click', () => {
                lightbox.style.display = 'none';
            });
            
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) { 
                    lightbox.style.display = 'none';
                }
            });
        }
        
        // --- 6. HÀM ADD MARKERS (Giữ nguyên) ---
        function addMarkers() {
            markers = []; 
            const bounds = new google.maps.LatLngBounds(); 

            planData.forEach((plan, planIndex) => {
                const planColor = planColors[planIndex % planColors.length];

                plan.waypoints.forEach((wp, waypointIndex) => {
                    let markerColor = planColor; 
                    if (wp.activity.includes("サプライズ") || wp.activity.includes("おまかせ")) {
                        markerColor = '#9333EA'; 
                    }

                    const marker = new google.maps.Marker({
                        position: wp.location,
                        map: map,
                        label: {
                            text: (waypointIndex + 1).toString(),
                            color: 'white',
                            fontWeight: 'bold'
                        },
                        title: wp.name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: markerColor,
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: 'white'
                        },
                        planIndex: planIndex,
                        waypointIndex: waypointIndex
                    });

                    marker.addListener('click', () => {
                        const content = `
                            <div style="max-width: 220px; padding: 5px; font-family: 'Inter', sans-serif;">
                                <strong style="font-size: 1.1em; color: #1f2937;">${wp.name}</strong>
                                <p style="font-size: 0.9em; margin-top: 5px; color: #4b5563;">${wp.info}</p>
                            </div>`;
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                    });
                    
                    markers.push(marker); 
                    bounds.extend(wp.location); 
                });
            });

            // map.fitBounds(bounds); // Sẽ fit trong createAllRouteRenderers
        }

        // --- 7. HÀM ADD PANEL LISTENERS (ĐÃ SỬA) ---
        function addPanelListeners() {
            // (Giữ nguyên code listener cho waypoint-item và thumbnail-img)
             // === Listener cho các ĐỊA ĐIỂM (WAYPOINT) ===
            const items = document.querySelectorAll('.waypoint-item');
            items.forEach((item) => {
                const planIndex = parseInt(item.dataset.planIndex, 10);
                const waypointIndex = parseInt(item.dataset.waypointIndex, 10);
                
                if (isNaN(planIndex) || isNaN(waypointIndex)) return; 
                
                const marker = markers.find(m => m.planIndex === planIndex && m.waypointIndex === waypointIndex);
                if (!marker) return; 

                item.addEventListener('mouseover', (e) => {
                    if (!e.target.classList.contains('thumbnail-img')) {
                         marker.setAnimation(google.maps.Animation.BOUNCE);
                    }
                });
                item.addEventListener('mouseout', () => {
                    marker.setAnimation(null);
                });
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('thumbnail-img')) {
                        google.maps.event.trigger(marker, 'click'); 
                        map.panTo(marker.getPosition());
                        map.setZoom(16); 
                    }
                });
            });

            // === Listener cho các ẢNH (THUMBNAIL) === (Giữ nguyên)
            const thumbnails = document.querySelectorAll('.thumbnail-img');
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    
                    const photoRef = thumb.dataset.photoref;
                    const largePhotoUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=1600&photoreference=${photoRef}&key=${API_KEY}`;
                    
                    lightboxImg.src = largePhotoUrl; 
                    lightbox.style.display = 'block'; 
                });
            });


            // === Listener cho DROPDOWN (THẺ <DETAILS>) ===
            const allDropdowns = document.querySelectorAll('.plan-dropdown');
            
            allDropdowns.forEach(detailsElement => {
                detailsElement.addEventListener('toggle', (event) => {
                    const planIndex = parseInt(detailsElement.dataset.planIndex, 10);
                    
                    if (!routeRenderers[planIndex]) return; 
                    const renderer = routeRenderers[planIndex];

                    if (detailsElement.open) {
                        renderer.setMap(map); // Hiển thị đường đi
                        map.fitBounds(renderer.getDirections().routes[0].bounds); // Fit map
                        
                        // Đóng tất cả các <details> khác
                        allDropdowns.forEach(otherDetail => {
                            if (otherDetail !== detailsElement) {
                                otherDetail.open = false;
                            }
                        });
                        
                    } else {
                        // Ẩn đường đi
                        renderer.setMap(null);
                    }
                });
            });
        }
        
        // --- 8. HÀM TẠO ĐƯỜNG ĐI (ĐÃ SỬA) ---
        function createAllRouteRenderers() {
            routeRenderers = []; 
            let bounds = new google.maps.LatLngBounds();

            planData.forEach((plan, planIndex) => {
                const planColor = planColors[planIndex % planColors.length];

                const newRenderer = new google.maps.DirectionsRenderer({
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: planColor,
                        strokeWeight: 5,
                        strokeOpacity: 0.8
                    }
                });

                newRenderer.setMap(null); // Ẩn ban đầu

                const waypts = [];
                for (let i = 1; i < plan.waypoints.length - 1; i++) {
                    waypts.push({
                        location: plan.waypoints[i].location,
                        stopover: true,
                    });
                }
                
                const hasDriving = plan.waypoints.some(wp => wp.transport_mode === '車');
                const transportMode = hasDriving ? 'DRIVING' : 'WALKING';

                directionsService.route({
                    origin: plan.waypoints[0].location, 
                    destination: plan.waypoints[plan.waypoints.length - 1].location, 
                    waypoints: waypts, 
                    optimizeWaypoints: false, 
                    travelMode: google.maps.TravelMode[transportMode]
                })
                .then((response) => {
                    newRenderer.setDirections(response); 
                    
                    // Mở và hiển thị route cho kế hoạch đầu tiên
                    if (planIndex === 0) {
                        newRenderer.setMap(map);
                        map.fitBounds(response.routes[0].bounds);
                    }
                })
                .catch((e) => console.warn("Lỗi tính đường đi cho plan " + planIndex + ": " + e)); 

                routeRenderers[planIndex] = newRenderer;
            });
        }
        
        // --- 9. HÀM TẢI GOOGLE SCRIPT ---
        function loadGoogleMapsScript() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=places`;
                script.async = true;
                document.head.appendChild(script);
            } else {
                initMap();
            }
        }

    </script>
</body>
</html>